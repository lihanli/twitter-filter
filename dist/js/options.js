// Generated by CoffeeScript 1.6.3
(function() {
  var TwitterUser, TwitterUsers, convertToBackboneArr, dom, removeByIndex, twitterUsers;

  dom = {
    filteredUserInput: $('.filtered-user-input'),
    filteredUsers: $('.filtered-users')
  };

  TwitterUser = Backbone.Model.extend({
    initialize: function() {
      return this.set({
        screenName: this.get('screenName').toLowerCase()
      });
    }
  });

  TwitterUsers = Backbone.Collection.extend({
    model: TwitterUser,
    add: function(twitterUser) {
      if (this.any(function(_twitterUser) {
        return _twitterUser.get('screenName') === twitterUser.get('screenName');
      })) {
        return false;
      }
      return Backbone.Collection.prototype.add.apply(this, arguments);
    }
  });

  twitterUsers = null;

  convertToBackboneArr = function(Model, arr) {
    return _.map(arr, function(item) {
      return new Model(item);
    });
  };

  removeByIndex = function(collection, idx) {
    return collection.remove(collection.models[idx]);
  };

  chrome.extension.sendMessage({
    filteredUsers: null
  }, function(res) {
    twitterUsers = new TwitterUsers(convertToBackboneArr(TwitterUser, res.filteredUsers));
    twitterUsers.on('add', function(twitterUser, collection) {
      var el;
      el = $("<li>\n  @" + (_.escape(twitterUser.get('screenName'))) + "\n  <a class=\"close\">&times;</a>\n</li>").data('model', twitterUser);
      return dom.filteredUsers.append(el);
    });
    return twitterUsers.on('remove', function(twitterUser, __, opt) {
      return $(dom.filteredUsers.find('li')[opt.index]).remove();
    });
  });

  dom.filteredUsers.on('click', '.close', function() {
    var el;
    el = $(this).parents('li');
    return twitterUsers.remove(el.data('model'));
  });

  dom.filteredUserInput.keypress(function(e) {
    var screenName;
    if (e.keyCode === 13) {
      screenName = $.trim(dom.filteredUserInput.val()).replace(/\W/g, '');
      if (util.isBlank(screenName)) {
        return;
      }
      twitterUsers.add(new TwitterUser({
        screenName: screenName
      }));
      return dom.filteredUserInput.val('');
    }
  });

}).call(this);
