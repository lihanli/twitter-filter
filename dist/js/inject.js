// Generated by CoffeeScript 1.6.3
(function() {
  var dom, filterCurrentPage, filterTweets, filteredUsers, getTweetData, hasClass, options, rclass;

  if (location.host === 'twitter.com') {
    rclass = /[\n\t]/g;
    filteredUsers = null;
    options = null;
    dom = {
      streamContainer: $('.stream-container')
    };
    getTweetData = (function() {
      var Tweet;
      Tweet = (function() {
        function Tweet($el) {
          this.screenName = $el.data('screen-name');
        }

        return Tweet;

      })();
      return function($el) {
        var tweet;
        tweet = $el.data('tf-tweet');
        if (tweet) {
          return tweet;
        }
        tweet = new Tweet($el);
        $el.data('tf-tweet', tweet);
        return tweet;
      };
    })();
    hasClass = function(el, selector) {
      var className;
      className = " " + selector + " ";
      if ((" " + el.className + " ").replace(rclass, " ").indexOf(className) > -1) {
        return true;
      }
      return false;
    };
    filterCurrentPage = function() {
      return filterTweets(document.querySelectorAll('.stream-items li'));
    };
    filterTweets = function(els) {
      var $els, toHide;
      $els = $(els);
      toHide = [];
      $els.find('.tweet').each(function() {
        var $this, tweet;
        $this = $(this);
        tweet = getTweetData($this);
        $this.show();
        $this.find('.content').show();
        $this.find('.tf-el').remove();
        $this.find('.account-group').after("<a class=\"toggle-hide tf-el\">\n  Hide\n</a>");
        if (filteredUsers.findWhere({
          screenName: tweet.screenName.toLowerCase()
        })) {
          return toHide.push({
            $el: $this
          });
        }
      });
      return _.each(toHide, function(hideObj) {
        var $el, replacement, tweet;
        $el = hideObj.$el;
        tweet = getTweetData($el);
        if (options.get('hideCompletely')) {
          return $el.hide();
        } else {
          $el = $el.find('.content');
          replacement = $("<div class=\"hidden-message tf-el\">\n  " + (_.escape(tweet.screenName)) + "'s tweet has been filtered. <a>Show?</a>\n</div>");
          replacement.find('a').click(function() {
            $el.show();
            return replacement.remove();
          });
          return $el.hide().after(replacement);
        }
      });
    };
    dom.streamContainer.on('click', '.tweet .toggle-hide', function() {
      var tweet;
      tweet = $(this).parents('.tweet').data('tf-tweet');
      if (confirm("Are you sure you want to hide all of " + tweet.screenName + "'s tweets?")) {
        return console.log('foo');
      }
    });
    (function() {
      var filteredUsersDeferred, optionsDeferred;
      filteredUsersDeferred = $.Deferred();
      optionsDeferred = $.Deferred();
      chrome.extension.sendMessage({
        filteredUsers: null
      }, function(res) {
        filteredUsers = models.generateTwitterUsers({
          users: res.filteredUsers
        });
        return filteredUsersDeferred.resolve();
      });
      chrome.extension.sendMessage({
        options: null
      }, function(res) {
        options = new models.Options(res.options);
        return optionsDeferred.resolve();
      });
      return $.when(filteredUsersDeferred, optionsDeferred).then(function() {
        return filterCurrentPage();
      });
    })();
    (function() {
      var addObserver, observer, oldLocation;
      observer = null;
      addObserver = function() {
        if (observer) {
          observer.disconnect();
        }
        observer = new MutationObserver(function(mutations) {
          return mutations.forEach(function(mutation) {
            var addedNodes;
            addedNodes = mutation.addedNodes;
            if (addedNodes.length > 0 && hasClass(addedNodes[0], 'stream-item')) {
              return filterTweets(addedNodes);
            }
          });
        });
        return observer.observe(document.querySelector('.stream-items'), {
          childList: true
        });
      };
      addObserver();
      oldLocation = location.href;
      return setInterval(function() {
        if (location.href !== oldLocation) {
          oldLocation = location.href;
          filterCurrentPage();
          return addObserver();
        }
      }, 500);
    })();
  }

}).call(this);
